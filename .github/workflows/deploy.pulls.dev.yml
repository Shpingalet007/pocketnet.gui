name: Deploy Dev PR

on:
  workflow_dispatch:
    inputs:
      network:
        type: choice
        description: 'Select network'
        required: true
        default: 'Testnet'
        options:
          - 'Testnet'
          - 'Mainnet'
      build_all:
        description: 'Build all'
        required: false
        default: true
      build_android:
        description: 'Build Android'
        required: false
        default: true
      build_windows:
        description: 'Build Windows'
        required: false
        default: true
      build_macos:
        description: 'Build macOS'
        required: false
        default: true
      build_linux:
        description: 'Build Linux'
        required: false
        default: true

jobs:
  # Merge all 'deploy.dev' PRs to master branch
  merge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout git repository
        uses: actions/checkout@v3
        with:
          ref: master
          fetch-depth: 0 # We need a complete history for merging branches
      - uses: andyoknen/combine-pull-requests@v1
        with:
          label: deploy.dev
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Archive merged repo
        run: |
          mkdir -p /tmp/repo
          rsync -ah --exclude={'.git','.gitignore','.github','node_modules','.well-known'} ./ /tmp/repo/
          cd /tmp/repo
          tar czf /tmp/repo.tgz ./
      - name: Upload artifact repo.tgz
        uses: actions/upload-artifact@v3
        with:
          name: repo.tgz
          path: /tmp/repo.tgz
      - name: Save artifact head.txt
        uses: actions/upload-artifact@v3
        with:
          name: head
          path: ./head.txt
